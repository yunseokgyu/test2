<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>복리 계산기</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-color: #34d399;
            /* Neon Green/Emerald */
            --accent-hover: #10b981;
            --glass-border: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(15, 23, 42, 0.6);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 2rem;
            min-height: 100vh;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(52, 211, 153, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 20%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        header p {
            color: var(--text-secondary);
        }

        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 900px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
        }

        .input-row-three {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            align-items: end;
        }

        @media (max-width: 600px) {
            .input-row-three {
                grid-template-columns: 1fr;
            }
        }

        /* Input Section */
        .input-section h2,
        .target-section h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .input-group {
            margin-bottom: 1.25rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.2);
        }

        button {
            width: 100%;
            padding: 1rem;
            background: var(--accent-color);
            color: #0f172a;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            margin-top: 1rem;
        }

        button:hover {
            background-color: var(--accent-hover);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        /* Target Section Toggle */
        .toggle-fees details summary {
            list-style: none;
            /* Hide default triangle if desired, or keep it */
        }

        .toggle-fees details summary::-webkit-details-marker {
            display: none;
        }

        .input-row {
            display: flex;
            gap: 1rem;
        }

        .input-group.half {
            flex: 1;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .tab-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: auto;
            margin-top: 0;
        }

        .tab-btn.active {
            background: rgba(52, 211, 153, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        /* Result Section */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 600px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }

        .card {
            padding: 1.5rem;
            text-align: center;
        }

        .card h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .amount.small {
            font-size: 1.25rem;
        }

        .amount.highlight {
            color: var(--accent-color);
        }

        .chart-container {
            height: 400px;
            position: relative;
            padding: 1.5rem;
        }

        /* Split Table Section */
        .split-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .split-header h2 {
            font-size: 1.25rem;
            margin-bottom: 0;
        }

        .small-btn {
            width: auto;
            margin-top: 0;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .btn-delete {
            background: transparent;
            color: #ef4444;
            font-size: 1.5rem;
            padding: 0;
            width: auto;
            margin-top: 0;
        }

        .btn-delete:hover {
            background: transparent;
            color: #f87171;
            transform: none;
        }

        /* Table Section */
        .table-section h2 {
            margin-bottom: 1.5rem;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        th,
        td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid var(--glass-border);
            vertical-align: middle;
        }

        th:first-child,
        td:first-child {
            text-align: center;
        }

        th {
            color: var(--text-secondary);
            font-weight: 600;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Split Table Inputs Refined */
        #split-table input {
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-primary);
            text-align: center;
            width: 100%;
            padding: 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        #split-table input:focus {
            background: rgba(52, 211, 153, 0.05);
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.1);
        }

        #split-table input::-webkit-outer-spin-button,
        #split-table input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #split-table input[type=number] {
            -moz-appearance: textfield;
        }

        /* Card Input Styles */
        .card-input {
            width: 100%;
            background: transparent;
            border: none;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            outline: none;
            padding: 0;
        }

        .card-input:focus {
            border-bottom: 2px solid var(--accent-color);
        }

        .card-input::-webkit-outer-spin-button,
        .card-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .card-input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>복리 계산기</h1>
            <p>시간과 복리의 마법으로 자산을 키우세요</p>
        </header>

        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="compound">복리 계산기</button>
            <button class="tab-btn" data-tab="stock">주식 수익률 계산기</button>
        </div>

        <!-- Compound Tab -->
        <div id="tab-compound" class="tab-content active">
            <div class="calculator-grid">
                <div class="input-section glass-panel">
                    <h2>투자 설정</h2>
                    <div class="input-group">
                        <label for="initial-investment">초기 투자금 (원)</label>
                        <input type="text" id="initial-investment" value="10,000,000" inputmode="numeric">
                    </div>
                    <div class="input-group">
                        <label for="monthly-contribution">월 적립액 (원)</label>
                        <input type="text" id="monthly-contribution" value="1,000,000" inputmode="numeric">
                    </div>
                    <div class="input-group">
                        <label for="interest-rate">연 이자율 (%)</label>
                        <input type="number" id="interest-rate" value="7" step="0.1" min="0">
                    </div>
                    <div class="input-group">
                        <label for="years">투자 기간 (년)</label>
                        <input type="number" id="years" value="10" min="1" max="100">
                    </div>
                    <div class="input-group">
                        <label for="compound-frequency">복리 횟수</label>
                        <select id="compound-frequency">
                            <option value="12">매월 (Monthly)</option>
                            <option value="1">매년 (Yearly)</option>
                        </select>
                    </div>
                    <button id="calculate-btn">계산하기</button>
                </div>

                <div class="result-section">
                    <div class="summary-cards">
                        <div class="card glass-panel">
                            <h3>최종 금액</h3>
                            <p class="amount" id="final-balance">0원</p>
                        </div>
                        <div class="card glass-panel">
                            <h3>총 원금</h3>
                            <p class="amount small" id="total-principal">0원</p>
                        </div>
                        <div class="card glass-panel">
                            <h3>총 이자 수익</h3>
                            <p class="amount small highlight" id="total-interest">0원</p>
                        </div>
                    </div>

                    <div class="chart-container glass-panel">
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="table-section glass-panel">
                <h2>연도별 현황</h2>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>연도</th>
                                <th>총 원금</th>
                                <th>이자 수익</th>
                                <th>누적 이자</th>
                                <th>총 잔액</th>
                            </tr>
                        </thead>
                        <tbody id="breakdown-body">
                            <!-- Rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Stock Tab -->
        <div id="tab-stock" class="tab-content" style="display: none;">
            <div class="calculator-grid">
                <div class="target-section glass-panel">
                    <h2>주식 매매 설정</h2>
                    <div class="input-row-three">
                        <div class="input-group">
                            <label for="stock-buy-price">매수 단가 (원)</label>
                            <input type="text" id="stock-buy-price" value="0" inputmode="numeric">
                        </div>
                        <div class="input-group">
                            <label for="stock-quantity">수량 (주)</label>
                            <input type="text" id="stock-quantity" value="0" inputmode="numeric">
                        </div>
                    </div>

                    <div class="toggle-fees">
                        <details>
                            <summary style="cursor: pointer; color: var(--text-secondary); margin-bottom: 0.5rem;">수수료 및
                                세금 설정 (펼치기)</summary>
                            <div class="input-row">
                                <div class="input-group half">
                                    <label for="fee-buy">매수 수수료 (%)</label>
                                    <input type="number" id="fee-buy" value="0.015" step="0.001">
                                </div>
                                <div class="input-group half">
                                    <label for="fee-sell">매도 수수료 (%)</label>
                                    <input type="number" id="fee-sell" value="0.015" step="0.001">
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="tax-rate">증권거래세 (%)</label>
                                <input type="number" id="tax-rate" value="0.20" step="0.01">
                            </div>
                        </details>
                    </div>
                </div>

                <div class="result-section">

                    <!-- Target Section (MOVED UP) -->
                    <h3 style="margin: 0rem 0 1rem 0; color: var(--text-secondary);">예상 목표 수익</h3>
                    <div class="summary-cards">
                        <div class="card glass-panel" style="padding: 1.5rem;">
                            <h3 style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">총 매수 금액
                                (원)</h3>
                            <input type="text" id="stock-total-amount-card" class="card-input" value="0"
                                inputmode="numeric">
                        </div>
                        <div class="card glass-panel" style="padding: 1.5rem;">
                            <h3 style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">목표 수익률
                                (%)</h3>
                            <input type="number" id="target-return-rate" class="card-input highlight-input" value="10"
                                step="0.1" style="color: var(--accent-color);">
                        </div>
                        <div class="card glass-panel" style="padding: 1.5rem;">
                            <h3 style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">목표 손익 금액
                                (원)</h3>
                            <input type="text" id="target-profit-amount" class="card-input highlight-input" value="0"
                                inputmode="numeric" style="color: var(--accent-color);">
                        </div>
                    </div>

                    <!-- Realized Profit Section -->
                    <h3 style="margin-bottom: 1rem; color: var(--text-secondary);">예상 실현 수익</h3>
                    <div class="summary-cards">
                        <div class="card glass-panel">
                            <h3>총 매수 금액</h3>
                            <p class="amount" id="stock-total-buy">0원</p>
                        </div>
                        <div class="card glass-panel">
                            <h3>실현 수익률</h3>
                            <p class="amount highlight" id="stock-return-rate">0.00%</p>
                        </div>
                        <div class="card glass-panel">
                            <h3>실현 손익</h3>
                            <p class="amount highlight" id="stock-net-profit">0원</p>
                        </div>
                    </div>

                    <!-- Split Sell Planner (MOVED DOWN) -->
                    <div class="split-sell-section glass-panel" style="margin-bottom: 2rem;">
                        <div class="split-header">
                            <h2>분할 매도 플래너</h2>
                            <button id="add-split-btn" class="small-btn">+ 구간 추가</button>
                        </div>
                        <div class="table-wrapper">
                            <table id="split-table">
                                <thead>
                                    <tr>
                                        <!-- NEW ORDER: Ratio, Return %, Sell Qty, Sell Price, Total Profit, Delete -->
                                        <th>비율 (%)</th>
                                        <th>수익률 (%)</th>
                                        <th>매도 수량</th>
                                        <th>매도 단가</th>
                                        <th>총 이익 (목표)</th>
                                        <th>삭제</th>
                                    </tr>
                                </thead>
                                <tbody id="split-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT INLINED TO PREVENT CACHE ISSUES -->
    <script>
        // Chart Instance
        let growthChart = null;

        // Initial Setup
        document.addEventListener('DOMContentLoaded', () => {
            // Tab Switching
            const tabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => {
                        c.style.display = 'none';
                        c.classList.remove('active');
                    });

                    tab.classList.add('active');
                    const targetId = `tab-${tab.dataset.tab}`;
                    const targetContent = document.getElementById(targetId);
                    targetContent.style.display = 'block';
                    setTimeout(() => targetContent.classList.add('active'), 10);
                });
            });

            // --- Compound Interest Logic ---
            const initialInvestmentInput = document.getElementById('initial-investment');
            const monthlyContributionInput = document.getElementById('monthly-contribution');
            const interestRateInput = document.getElementById('interest-rate');
            const yearsInput = document.getElementById('years');
            const compoundFrequencySelect = document.getElementById('compound-frequency');
            const calculateBtn = document.getElementById('calculate-btn');

            const currencyInputs = [initialInvestmentInput, monthlyContributionInput];
            const inputs = [initialInvestmentInput, monthlyContributionInput, interestRateInput, yearsInput, compoundFrequencySelect];

            currencyInputs.forEach(input => {
                input.addEventListener('input', handleCurrencyInput);
            });

            inputs.slice(2).forEach(input => {
                input.addEventListener('input', calculateAndRender);
            });

            calculateBtn.addEventListener('click', calculateAndRender);
            calculateAndRender();

            // --- Stock Yield Logic ---
            const stockBuyPriceInput = document.getElementById('stock-buy-price');
            const stockQuantityInput = document.getElementById('stock-quantity');
            const feeBuyInput = document.getElementById('fee-buy');
            const feeSellInput = document.getElementById('fee-sell');
            const taxRateInput = document.getElementById('tax-rate');
            const addSplitBtn = document.getElementById('add-split-btn');

            // !!! CRITICAL FIX: LINK TO THE CARD INPUT, NOT THE HIDDEN ONE !!!
            const stockTotalAmountInput = document.getElementById('stock-total-amount-card');

            const targetReturnRateInput = document.getElementById('target-return-rate');
            const targetProfitAmountInput = document.getElementById('target-profit-amount');

            stockBuyPriceInput.addEventListener('input', (e) => {
                handleCurrencyInput(e);
                syncTotalAmount();
                syncTargetProfit();
                calculateStockYield();
            });

            stockQuantityInput.addEventListener('input', (e) => {
                handleCurrencyInput(e);
                syncTotalAmount();
                syncTargetProfit();
                calculateStockYield();
            });

            stockTotalAmountInput.addEventListener('input', (e) => {
                handleCurrencyInput(e);
                syncQuantity();
                calculateStockYield();
                syncTargetProfit();
            });

            targetReturnRateInput.addEventListener('input', () => {
                syncTargetProfit();
            });

            targetProfitAmountInput.addEventListener('input', (e) => {
                handleCurrencyInput(e);
                syncTargetReturn();
            });

            [feeBuyInput, feeSellInput, taxRateInput].forEach(input => {
                input.addEventListener('input', calculateStockYield);
            });

            addSplitBtn.addEventListener('click', addSplitRow);

            // Add initial row and calc
            addSplitRow();
            calculateStockYield();

            // Shared Helper
            function handleCurrencyInput(e) {
                const rawValue = e.target.value.replace(/[^0-9]/g, '');
                if (rawValue) {
                    e.target.value = parseInt(rawValue).toLocaleString();
                } else {
                    e.target.value = 0;
                }
                if (e.target.id.includes('stock') || e.target.id.includes('target')) {
                    // Specific trigger for stock inputs logic
                    // If target profit changed, we don't assume total recalc unless handled
                } else {
                    calculateAndRender();
                }
            }

            // Compound Calc Functions
            function calculateAndRender() {
                const principal = parseFloat(initialInvestmentInput.value.replace(/,/g, '')) || 0;
                const monthly = parseFloat(monthlyContributionInput.value.replace(/,/g, '')) || 0;
                const rate = parseFloat(interestRateInput.value) || 0;
                const years = parseInt(yearsInput.value) || 0;
                const frequency = parseInt(compoundFrequencySelect.value);

                if (years <= 0) return;

                const results = calculateCompoundInterest(principal, monthly, rate, years, frequency);
                updateUI(results);
                updateChart(results);
            }
        });

        // Compound Logic (Preserved)
        function calculateCompoundInterest(p, pmnt, r, t, n) {
            const rateDecimal = r / 100;
            const data = [];
            let currentBalance = p;
            let totalPrincipal = p;
            let totalInterest = 0;

            let yearlyData = [];
            yearlyData.push({
                year: 0,
                principal: p,
                interest: 0,
                balance: p,
                totalPrincipal: p
            });

            for (let year = 1; year <= t; year++) {
                let interestForYear = 0;
                for (let m = 0; m < 12; m++) {
                    currentBalance += pmnt;
                    totalPrincipal += pmnt;
                    if (n === 12) {
                        let interest = currentBalance * (rateDecimal / 12);
                        currentBalance += interest;
                        totalInterest += interest;
                        interestForYear += interest;
                    }
                }
                if (n === 1) {
                    let interest = currentBalance * rateDecimal;
                    currentBalance += interest;
                    totalInterest += interest;
                    interestForYear += interest;
                }
                yearlyData.push({
                    year: year,
                    totalPrincipal: totalPrincipal,
                    interest: totalInterest,
                    balance: currentBalance,
                    yearInterest: interestForYear
                });
            }
            return yearlyData;
        }

        function updateUI(data) {
            const lastPoint = data[data.length - 1];
            document.getElementById('final-balance').textContent = formatMoney(lastPoint.balance);
            document.getElementById('total-principal').textContent = formatMoney(lastPoint.totalPrincipal);
            document.getElementById('total-interest').textContent = formatMoney(lastPoint.interest);

            const tbody = document.getElementById('breakdown-body');
            tbody.innerHTML = '';
            data.slice(1).forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.year}년차</td><td>${formatMoney(row.totalPrincipal)}</td><td>${formatMoney(row.yearInterest)}</td><td>${formatMoney(row.interest)}</td><td style="font-weight:bold; color:var(--accent-color)">${formatMoney(row.balance)}</td>`;
                tbody.appendChild(tr);
            });
        }

        function updateChart(data) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            const labels = data.map(d => `${d.year}년`);

            if (growthChart) growthChart.destroy();

            growthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '총 평가액 (Total Balance)',
                        data: data.map(d => d.balance),
                        borderColor: '#34d399',
                        backgroundColor: 'rgba(52, 211, 153, 0.2)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: '투자 원금 (Principal)',
                        data: data.map(d => d.totalPrincipal),
                        borderColor: '#94a3b8',
                        backgroundColor: 'rgba(148, 163, 184, 0.2)',
                        fill: true,
                        tension: 0.4
                    }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255,255,255,0.05)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255,255,255,0.05)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW'
            }).format(amount);
        }

        // --- Stock Logic Functions ---
        function parseCurrency(str) {
            if (!str) return 0;
            if (typeof str === 'number') return str;
            return parseFloat(str.replace(/[^0-9.-]+/g, "")) || 0;
        }

        function calculateStockYield() {
            const getVal = (id) => parseCurrency(document.getElementById(id).value);
            const buyPrice = getVal('stock-buy-price');
            const quantity = getVal('stock-quantity');
            const buyFeeRate = parseFloat(document.getElementById('fee-buy').value) || 0;
            const sellFeeRate = parseFloat(document.getElementById('fee-sell').value) || 0;
            const taxRate = parseFloat(document.getElementById('tax-rate').value) || 0;

            const totalBuyAmount = buyPrice * quantity;
            const buyFee = Math.floor(totalBuyAmount * (buyFeeRate / 100));

            document.getElementById('stock-total-buy').textContent = formatMoney(totalBuyAmount);

            const splitRows = document.querySelectorAll('#split-body tr');
            let totalSellAmount = 0;
            let totalExpectedProfit = 0;

            splitRows.forEach(row => {
                const ratioInput = row.querySelector('.split-ratio');
                const profitInput = row.querySelector('.split-profit-input');
                const returnInput = row.querySelector('.split-return-input');
                const sellPriceCell = row.querySelector('.split-sell-price');
                const sellQtyCell = row.querySelector('.split-sell-qty');

                const ratio = parseFloat(ratioInput.value) || 0;
                const splitQty = Math.floor(quantity * (ratio / 100));
                let targetReturn = parseFloat(returnInput.value) || 0;
                const splitBuyAmt = buyPrice * splitQty;
                const splitBuyFee = splitBuyAmt * (buyFeeRate / 100);
                const splitCost = splitBuyAmt + splitBuyFee;
                const totalSellRate = (sellFeeRate + taxRate) / 100;

                targetReturn = parseFloat(returnInput.value) || 0;

                // Calculate Sell Price based on ROI (Return % is Net Profit / Total Cost)
                // NetProfit = Cost * (ROI / 100)
                // SellAmt = (Cost + NetProfit) / (1 - SellFees)
                const targetNetProfit = splitCost * (targetReturn / 100);

                let targetSellPrice = 0;
                if (1 - totalSellRate > 0.0001) {
                    const targetSellAmt = (splitCost + targetNetProfit) / (1 - totalSellRate);
                    targetSellPrice = targetSellAmt / splitQty;
                }

                sellPriceCell.textContent = formatMoney(targetSellPrice);
                sellQtyCell.textContent = splitQty.toLocaleString() + '주';

                const splitSellAmt = targetSellPrice * splitQty;
                const splitSellFee = splitSellAmt * (sellFeeRate / 100);
                const splitSellTax = splitSellAmt * (taxRate / 100);

                // Standard Net Profit Calc to verify/update profit input
                const netProfit = splitSellAmt - splitSellFee - splitSellTax - splitBuyAmt - splitBuyFee;

                if (document.activeElement !== profitInput) {
                    profitInput.value = Math.round(netProfit);
                }

                totalSellAmount += splitSellAmt;
                totalExpectedProfit += netProfit;
            });

            let avgReturn = 0;
            if (totalBuyAmount > 0) {
                const totalCost = totalBuyAmount + buyFee;
                avgReturn = (totalExpectedProfit / totalCost) * 100;
            }

            //document.getElementById('stock-total-sell').textContent = formatMoney(totalSellAmount);

            const netProfitEl = document.getElementById('stock-net-profit');
            netProfitEl.textContent = formatMoney(totalExpectedProfit);
            netProfitEl.style.color = totalExpectedProfit >= 0 ? 'var(--accent-color)' : '#ef4444';

            const returnRateEl = document.getElementById('stock-return-rate');
            returnRateEl.textContent = avgReturn.toFixed(2) + '%';
            returnRateEl.style.color = avgReturn >= 0 ? 'var(--accent-color)' : '#ef4444';
        }

        function addSplitRow() {
            const tbody = document.getElementById('split-body');
            const tr = document.createElement('tr');
            // Re-ordered Layout: Ratio -> Return % -> Sell Qty -> Sell Price -> Total Profit -> Delete
            tr.innerHTML = `
                <td><input type="number" class="split-ratio" value="50" step="10"></td>
                <td><input type="number" class="split-return-input" value="10" step="0.1"></td>
                <td class="split-sell-qty">-</td>
                <td class="split-sell-price">-</td>
                <td><input type="number" class="split-profit-input" value="0"></td>
                <td><button class="btn-delete" onclick="this.closest('tr').remove(); calculateStockYield()">×</button></td>
            `;

            const profitInput = tr.querySelector('.split-profit-input');
            const returnInput = tr.querySelector('.split-return-input');
            const ratioInput = tr.querySelector('.split-ratio');

            profitInput.addEventListener('input', (e) => {
                const profit = parseFloat(e.target.value) || 0;
                const buyPrice = parseCurrency(document.getElementById('stock-buy-price').value);
                const quantity = parseCurrency(document.getElementById('stock-quantity').value);
                const ratio = parseFloat(ratioInput.value) || 0;
                const splitQty = Math.floor(quantity * (ratio / 100));

                if (splitQty <= 0 || buyPrice <= 0) return;

                const buyFeeRate = parseFloat(document.getElementById('fee-buy').value) || 0;
                const sellFeeRate = parseFloat(document.getElementById('fee-sell').value) || 0;
                const taxRate = parseFloat(document.getElementById('tax-rate').value) || 0;

                const splitBuyAmt = buyPrice * splitQty;
                const splitBuyFee = splitBuyAmt * (buyFeeRate / 100);
                const totalBuyCost = splitBuyAmt + splitBuyFee;

                // ROI = (Net Profit / Total Cost) * 100
                const returnRate = (profit / totalBuyCost) * 100;

                returnInput.value = returnRate.toFixed(2);
                calculateStockYield();
            });

            returnInput.addEventListener('input', () => calculateStockYield());
            ratioInput.addEventListener('input', calculateStockYield);

            tbody.appendChild(tr);
            calculateStockYield();
        }

        function syncTotalAmount() {
            const buyPriceInput = document.getElementById('stock-buy-price');
            const quantityInput = document.getElementById('stock-quantity');
            const totalAmountInput = document.getElementById('stock-total-amount-card'); // CORRECT ID

            const price = parseCurrency(buyPriceInput.value);
            const qty = parseCurrency(quantityInput.value);
            const total = price * qty;
            totalAmountInput.value = total.toLocaleString();
        }

        function syncQuantity() {
            const buyPriceInput = document.getElementById('stock-buy-price');
            const quantityInput = document.getElementById('stock-quantity');
            const totalAmountInput = document.getElementById('stock-total-amount-card'); // CORRECT ID

            const price = parseCurrency(buyPriceInput.value);
            const total = parseCurrency(totalAmountInput.value);
            if (price > 0) {
                const qty = Math.floor(total / price);
                quantityInput.value = qty.toLocaleString();
            }
        }

        function syncTargetProfit() {
            const totalInput = document.getElementById('stock-total-amount-card'); // CORRECT ID
            const rateInput = document.getElementById('target-return-rate');
            const profitInput = document.getElementById('target-profit-amount');
            if (!totalInput || !rateInput || !profitInput) return;

            const total = parseCurrency(totalInput.value);
            const rate = parseFloat(rateInput.value) || 0;
            const buyPrice = parseCurrency(document.getElementById('stock-buy-price').value);
            const quantity = parseCurrency(document.getElementById('stock-quantity').value);

            if (buyPrice > 0 && quantity > 0) {
                const buyFeeRate = parseFloat(document.getElementById('fee-buy').value) || 0;
                const sellFeeRate = parseFloat(document.getElementById('fee-sell').value) || 0;
                const taxRate = parseFloat(document.getElementById('tax-rate').value) || 0;

                const totalBuyAmt = buyPrice * quantity;
                const buyFee = totalBuyAmt * (buyFeeRate / 100);
                const totalCost = totalBuyAmt + buyFee;

                // Target Profit based on ROI (Net Profit = Cost * ROI%)
                const netProfit = totalCost * (rate / 100);

                /* 
                   If we need valid SellPrice for internal consistency (though not displayed here):
                   const totalSellRate = (sellFeeRate + taxRate) / 100;
                   const targetSellAmt = (totalCost + netProfit) / (1 - totalSellRate); 
                   const targetSellPrice = targetSellAmt / quantity;
                */

                profitInput.value = Math.round(netProfit).toLocaleString();
            } else {
                if (total > 0) {
                    const approxProfit = total * (rate / 100);
                    profitInput.value = Math.round(approxProfit).toLocaleString();
                } else {
                    profitInput.value = '0';
                }
            }
        }

        function syncTargetReturn() {
            const totalInput = document.getElementById('stock-total-amount-card'); // CORRECT ID
            const rateInput = document.getElementById('target-return-rate');
            const profitInput = document.getElementById('target-profit-amount');
            if (!totalInput || !rateInput || !profitInput) return;

            const total = parseCurrency(totalInput.value);
            const profit = parseCurrency(profitInput.value);
            if (total <= 0) return;

            const buyPrice = parseCurrency(document.getElementById('stock-buy-price').value);
            const quantity = parseCurrency(document.getElementById('stock-quantity').value);

            if (buyPrice > 0 && quantity > 0) {
                const buyFeeRate = parseFloat(document.getElementById('fee-buy').value) || 0;
                const sellFeeRate = parseFloat(document.getElementById('fee-sell').value) || 0;
                const taxRate = parseFloat(document.getElementById('tax-rate').value) || 0;

                const totalBuyAmt = buyPrice * quantity;
                const buyFee = totalBuyAmt * (buyFeeRate / 100);
                const totalBuyCost = totalBuyAmt + buyFee;

                // Return Rate = (Net Profit / Total Cost) * 100
                const returnRate = (profit / totalBuyCost) * 100;
                rateInput.value = returnRate.toFixed(2);
            } else {
                const rate = (profit / total) * 100;
                rateInput.value = rate.toFixed(2);
            }
        }
    </script>
</body>

</html>